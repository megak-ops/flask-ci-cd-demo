pipeline {
    agent any
    parameters {
        choice(
            name: 'ENV',
            choices: ['dev', 'staging', 'prod'],
            description: 'Choose environment'
        )
    }
    environment {
        PATH = "${HOME}/.local/bin:${env.PATH}"
    }
    stages {
        stage('Checkout') {
            steps {
                git branch: 'master',
                    credentialsId: 'megak-ops',
                    url: 'https://github.com/megak-ops/flask-ci-cd-demo.git'
            }
        }
        stage('Install Poetry') {
            steps {
                sh '''
                    curl -sSL https://install.python-poetry.org | python3 -
                    export PATH="$HOME/.local/bin:$PATH"
                    poetry --version
                '''
            }
        }
        stage('Install Dependencies') {
            steps {
                sh 'poetry install --no-interaction --no-ansi'
            }
        }
        stage('Lint') {
            steps {
                sh 'poetry run flake8 || true' // true عشان لو flake8 غايب ما يبطل pipeline
            }
        }
        stage('Unit Tests') {
            steps {
                sh 'poetry run pytest --junitxml=test-results.xml'
            }
            post {
                always {
                    junit 'test-results.xml'
                }
            }
        }
        stage('Build Docker Image') {
            steps {
                sh 'docker build -t flask-ci-demo .'
            }
        }
        stage('Push Image to DockerHub') {
    steps {
        withCredentials([usernamePassword(credentialsId: 'dockerhub-creds',
                                         usernameVariable: 'DOCKERHUB_USER',
                                         passwordVariable: 'DOCKERHUB_PASS')]) {
            script {
                def TAG = params.ENV
                sh """
                    echo "$DOCKERHUB_PASS" | docker login -u "$DOCKERHUB_USER" --password-stdin
                    docker tag flask-ci-demo ${DOCKERHUB_USER}/flask-ci-demo:${TAG}
                    docker push ${DOCKERHUB_USER}/flask-ci-demo:${TAG}
                """
            }
        }
    }
}
      stage('Deploy with Compose') {
    steps {
        script {
            def TAG = ""
            if (params.ENV == "dev")      TAG = "dev"
            if (params.ENV == "staging")  TAG = "staging"
            if (params.ENV == "prod")     TAG = "prod"

            sh """
                echo "Deploying with TAG=${TAG} ..."
                export TAG=${TAG}
                docker-compose -f docker-compose.yml down || true
                docker-compose -f docker-compose.yml up -d
            """
            }
        }
    }
}
